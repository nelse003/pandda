<!DOCTYPE HTML>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<title>xtalFREAD Data Visualisation</title>

        <script type="text/javascript">
            var ws;

            function trim(s){ 
                return ( s || '' ).replace( /^\s+|\s+$/g, '' ); 
            }

            function init() {
                var servermsg = document.getElementById("servermsg");
                ws = new WebSocket("ws://127.0.0.1:12346/");
                ws.onopen = function(){
                    servermsg.innerHTML = "Server Connected <br>" + servermsg.innerHTML;
                    //Request Headers in CSV File
                    postmsg('initial|request headers');
                    setTimeout(function(){postmsg('initial|request data length')},1000);
                };
                ws.onmessage = function(e){
                    
                    if (e.data == "Data Transfer Start") {
                        window.tag = 1;
                        window.graph_data = [];
                        servermsg.innerHTML = "<< Received data: " + e.data + "<br>" + servermsg.innerHTML;
                    }
                    else if (e.data == "Data Transfer End") {
                        window.tag = 0
                        var chart = $('#container').highcharts();
                        chart.xAxis[0].setTitle({text: window.axis_labels[0]});
                        chart.yAxis[0].setTitle({text: window.axis_labels[1]});
                        chart.series[0].setData(window.graph_data,true);
                        servermsg.innerHTML = "<< Received data: " + e.data + "<br>" + servermsg.innerHTML;
                    }
                    else if (window.tag==1) {
                        window.axis_labels = e.data.split(',')
                        window.tag = 2
                    }
                    else if (window.tag==2) {
                        servermsg.innerHTML = "<< Received data: " + e.data + "<br>" + servermsg.innerHTML;
                        window.graph_data.push(eval(e.data))
                    }
                    else if (e.data.lastIndexOf('Headers: ', 0) === 0) {
                        servermsg.innerHTML = "<< Received data: " + e.data + "<br>" + servermsg.innerHTML;
                        var selectX = document.getElementById("selectXaxis"); 
                        var selectY = document.getElementById("selectYaxis"); 
                        var options = e.data.replace('Headers:','').split(', '); 

                        for(var i = 0; i < options.length; i++) {
                            var opt = options[i];
                            var elx = document.createElement("option");
                            var ely = document.createElement("option");
                            elx.textContent = opt;
                            elx.value = opt;
                            selectX.appendChild(elx);
                            ely.textContent = opt;
                            ely.value = opt;
                            selectY.appendChild(ely);
                        }
                    }
                    else if (e.data.lastIndexOf('Data Length: ', 0) === 0) {
                        //servermsg.innerHTML = "<< Received data: " + e.data + "<br>" + servermsg.innerHTML;
                        var numrows = parseInt(e.data.replace('Data Length: ',''));
                        var showrow = document.getElementById("selectRow"); 

                        for(var i = 0; i < numrows; i++) {
                            var el = document.createElement("option");
                            el.textContent = i;
                            el.value = i;
                            showrow.appendChild(el);
                        }
                    }
                    else {
                        servermsg.innerHTML = "<< Received data: " + e.data + "<br>" + servermsg.innerHTML.split("<br>").slice(0,750).join("<br>");
                    }
                    
                };
                ws.onclose = function(){
                    servermsg.innerHTML = "Server Disconnected <br>" + servermsg.innerHTML;
                };
            }
            function postmsg(text){
                ws.send(text);
                servermsg.innerHTML = ">> Data sent: " + text + "<br>" + servermsg.innerHTML.split("<br>").slice(0,750).join("<br>");
            }
            //$(function(){
            //    var text = document.getElementById("message").value;
            //    ws.send(text);
            //    servermsg.innerHTML = servermsg.innerHTML + "<br>Sent: " + text;            
            //});

        </script>

		<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
		<script type="text/javascript">
$(function () {
        $('#container').highcharts({
            chart: {
                type: 'scatter',
                zoomType: 'xy',
                height: 0.7*window.innerHeight,
                width : 0.9*window.innerWidth
            },
            title: {
                text: 'A Viewer of Graphs'
            },
            subtitle: {
                text: 'Data Visualisation'
            },
            xAxis: {
                title: {
                    enabled: true,
                    text: 'None'
                },
                startOnTick: true,
                endOnTick: true,
                showLastLabel: true
            },
            yAxis: {
                title: {
                    text: 'None'
                }
            },
            legend: {
                layout: 'vertical',
                align: 'left',
                verticalAlign: 'top',
                x: 50,
                y: 30,
                floating: true,
                backgroundColor: '#FFFFFF',
                borderWidth: 1
            },
            plotOptions: {
                scatter: {
                    cursor: 'pointer',
                    point: {
                      events: {
                        click: function (e) {
                            hs.htmlExpand(null, {
                                pageOrigin: {
                                    x: e.pageX,
                                    y: e.pageY
                                },
                                headingText: this.series.name,
                                maincontentText: 'Label: '+this.options.label+'<br>Ref: '+this.options.ref,
                                width: 200
                            });
                            postmsg('selected|'+this.options.ref)
                        }
                      }
                    },
                    marker: {
                        radius: 2,
                        states: {
                            hover: {
                                enabled: true,
                                lineColor: 'rgb(100,100,100)'
                            }
                        }
                    },
                    states: {
                        hover: {
                            marker: {
                                enabled: false
                            }
                        }
                    },
                    tooltip: {
                        headerFormat: '<b>Click to Expand</b><br>',
                        pointFormat: '{point.label} : <br>REF: {point.ref}<br>X : {point.x}, Y : {point.y}'
                    }
                },
                series : {
                    turboThreshold: 0
                }
            },
            series: [{
                name: 'Data',
                data: []
                //color: 'rgba(223, 83, 83, .5)',
    
            //}, {
                //name: 'Other Things',
                //color: 'rgba(119, 152, 191, .5)',
                //data: [
                //        [0 , 1],[1 , 0]
                //     ]
            }]
        });
    });
    

		</script>
	</head>
	<body onload="init();">
<script src="http://code.highcharts.com/highcharts.js"></script>
<script src="http://code.highcharts.com/modules/exporting.js"></script>
<script src="http://code.highcharts.com/modules/data.js"></script>
<script type="text/javascript" src="http://www.highcharts.com/media/com_demo/highslide-full.min.js"></script>
<script type="text/javascript" src="http://www.highcharts.com/media/com_demo/highslide.config.js" charset="utf-8"></script>
<link rel="stylesheet" type="text/css" href="http://www.highcharts.com/media/com_demo/highslide.css" />
<!--<script type="text/javascript" src="http://www.highcharts.com/highslide/highslide-full.min.js"></script>-->
<!--<script type="text/javascript" src="http://www.highcharts.com/highslide/highslide.config.js" charset="utf-8"></script>-->
<!--<link rel="stylesheet" type="text/css" href="http://www.highcharts.com/highslide/highslide.css" />-->

<table>
    <tr>
        <td>
            <form id="axischoices" action="" onSubmit="var text = ['plot|',document.getElementById('selectXaxis').value,' v ',document.getElementById('selectYaxis').value].join(''); postmsg(text); return false;">
                <select id="selectXaxis">
                    <option value="None">X Axis</option>
                </select>
                <select id="selectYaxis">
                    <option value="None">Y Axis</option>
                </select>
                <input type="submit" name="submit" style="width: 50px" value="Plot" id="submitPlot">
            </form>
        </td>
        <td>
            <form id="manualload" action="" onSubmit="var text = ['selected|',document.getElementById('selectRow').value].join(''); document.getElementById('selectedrow').innerHTML = ['Current Row: ',document.getElementById('selectRow').value].join(''); postmsg(text); return false;">
                <select id="selectRow">
                    <option value="None">Load Row</option>
                </select>
                <input type="submit" name="submit2" style="width: 50px" value="Show" id="submitLoadRow">
            </form>
        </td>
        <td>
            <form id="loadnext" action="" onSubmit="document.getElementById('selectRow').selectedIndex++; document.getElementById('submitLoadRow').click(); return false">
                <input type="submit" style="width: 50px" value="Next" id="submitIncrRow">
            </form>
        </td>
        <td width='1*'>
            <div id='selectedrow'></div>
        </td>
    </tr>
</table><br>
<table>
    <tr>
        <td><div id="container" style="width: 100%; margin: 0 auto"></div></td>
    </tr>
</table>

<div id="commandtitle"><b>Send Commands:</b><br></div>
<form action="" onSubmit="var text = document.getElementById('message').value; postmsg(text); return false;">
  <input type="text" name="message" style="width: 80%" value="Enter Command Here" id="message">
  <input type="submit" name="submit" style="width: 50px" value="Submit" id="submitSendCommand">
</form>
<div id="header"><br><b>Message Log:</b><br></div>
<div id="servermsg"></div>
	</body>
</html>
